function setSrcObj(n){srcObj=n,currentTid=srcObj.nextSibling.getAttribute("tid")}function getFolderID(){return srcObj.nextSibling.id.substr(1)}function chkEnter(){var n=getEvent(),t=n.srcElement||n.target,i=n.keyCode||n.which;return i==13?(t.blur(),!1):!0}function chkScName(){var n=getEvent(),t=n.keyCode||n.which;return t==13?($("#ff_saveShortcut").click(),!1):!0}function setVisible(){$("#rwPower").css("display",$f("power_cbFullPower").checked?"none":""),$("#enFields").css("display",$f("power_rbSome").checked?"":"none"),$("#spanOptions").css("display",$f("power_rbNo").checked?"none":"")}function showBodyMenu(){var n=$(getEventSrc()),t,i;return n.is(".obj > span")&&(t=n.closest(".obj").addClass("temp"),i=within(n[0],getEvent()),t.removeClass("temp"),i)?(HideAllMenu(),!0):(HasPanelShowing()||(HideAllMenu(),$("#bodyMenu").attr("range")=="min"?($("#bodyMenu a").each(function(){$(this).css("display",$(this).is("#aSort,#find,[accesskey='G']")?"":"none")}),$("#bodyMenu div:empty").css("display","none")):($("#bodyMenu a[id$='Selected']").css("display",hasSelected("objsDiv")?"":"none"),$("#paste").css("display",$("#pasteSource").val()==""?"none":"")),ShowPop("bodyMenu")),CanelEvent())}function showObjMenu(){var n,i,t;return HasPanelShowing()||(n=getEventSrc(),setSrcObj(n),$("#curTempletId").val(currentTid),HideAllMenu(),i=$f("f"+currentTid),i?($f("sub_filters").innerHTML=i.innerHTML,$("#Open,#shortcut").addClass("hasSubMenus").mouseover(function(){showSubMenu("sub_filters")}).mouseout(function(){hideSubMenu("sub_filters")})):$("#Open,#shortcut").removeClass("hasSubMenus").unbind(),t=n.parentNode.getAttribute("adm")=="1",$("#filtersAdmin").css("display",t?"":"none").attr("href","Filters.aspx?tid="+currentTid),$("#appendData").css("display",t||n.parentNode.getAttribute("add")=="1"?"":"none"),$("#dataManage").prev().addBack().css("display",t?"":"none"),ShowPop("objMenu")),CanelEvent()}function addShortcut(n){return curParentMenu=="shortcut"?(__doPostBack("shortcut",n),shortcutAdded(),!1):!0}function doDefault(){var n=getEventSrc();setSrcObj(n),$("#curTempletId").val(currentTid),location=this.parentNode.className.indexOf("templet")>-1?"templet.aspx?tid="+currentTid:"View.aspx?tid="+currentTid}function design(){location="templet.aspx?tid="+currentTid}function Search(){location="advSearch.aspx?tid="+currentTid}function toAddData(){location="edit.aspx?tid="+currentTid}function InitFilter(n){$("select,:text,:radio","#"+n).focus(function(){$(this).closest("li").find(":checkbox:first").prop("checked",!0),$(this).closest("li span").find(":radio:first").prop("checked",!0)}),$("#"+n+" :text[enchars]").each(function(){eval("$(this)."+this.getAttribute("enchars"))})}function checkCond(){return hasSelected("ff_ulFilter")?!0:(alert("至少需要勾选一个条件！"),!1)}function del(){return confirm("删除模板将会同时删除基于该模板的任何数据，且不可恢复！确定要删除该模板吗？")?(PageMethods.delTemplet(currentTid,function(n){if(n==""){var t=srcObj.parentNode;t.parentNode.removeChild(t);try{parent.leftFrame.reloadTabs("templets")}catch(i){}}else alert("删除失败：\n"+n)}),!1):!1}function addTemplet(){var t=document.createElement("div"),r,i,n;return t.className="obj templet",r=document.createElement("div"),t.appendChild(r),i=document.createElement("span"),t.appendChild(i),n=document.createElement("input"),n.type="text",n.id="newName",n.value="新建模板",n.onfocus=function(){this.select()},n.onblur=doAddTemplet,n.onkeydown=chkEnter,i.appendChild(n),$f("objsDiv").appendChild(t),$f("newName").focus(),!1}function doAddTemplet(){var n=getEventSrc(),t;if(!n)return!1;if(t=$.trim(n.value),t=="")return n.focus(),!1;n.disabled="disabled",PageMethods.addTemplet(t,folderid,addTemplet_callback)}function addTemplet_callback(n){var i=$f("newName"),t;if(n.substr(0,1)=="_"){try{parent.leftFrame.reloadTabs("templets")}catch(r){}location="templet.aspx?tid="+n.substr(1)}else t=i.parentNode.parentNode,t.parentNode.removeChild(t),alert(n)}function rename(){var t=srcObj.nextSibling.firstChild,n=document.createElement("input");return n.type="text",n.id="newName",n.value=t.nodeValue,n.onfocus=function(){this.select()},n.onblur=doRename,n.onkeydown=chkEnter,oriNameNode=t.cloneNode(!0),t.parentNode.replaceChild(n,t),$f("newName").focus(),!1}function doRename(){var n=getEventSrc(),t;if(!n)return!1;if(n.value==oriNameNode.nodeValue)return n.parentNode.replaceChild(oriNameNode,n),!1;if(t=n.value.trim(),t=="")return n.focus(),!1;n.disabled="disabled",PageMethods.renameTemplet(currentTid,t,renameTemplet_callback)}function renameTemplet_callback(n){var t=$f("newName"),i;if(n==""){i=document.createTextNode(t.value),t.parentNode.replaceChild(i,t);try{parent.leftFrame.reloadTabs("templets")}catch(r){}}else t.parentNode.replaceChild(oriNameNode,t),alert(n)}function ajaxFileUpload(){var t=$("#res_popup .title").text()=="导入模板"?"templet":"zip",n=$f("fileToUpload").value;return n.substr(n.lastIndexOf(".")+1)!=t?(alert("无效的文件！"),!1):($(document).ajaxStart(function(){$("#loading1").show(),$("#res_popup .btnArea,#uploadArea").hide()}),$.ajaxFileUpload({url:"ajax.aspx?action=upload",secureuri:!1,fileElementId:"fileToUpload",dataType:"json",success:function(n){var t,i,r;typeof n.error!="undefined"&&n.error!=""?alert(n.error):(t=n.files,i=null,typeof t!="undefined"&&t!=null&&t.length>0&&(i=t[0]),i==null?alert("文件上传失败！"):(r=$("#res_popup .title").text()=="导入模板"?"templet":"zip",PageMethods.CheckFile(folderid,i,r,CheckFile_callback)))},error:function(n,t,i){alert(i)}}),!1)}function CheckFile_callback(n){if(n=eval("("+n+")"),n.complete==1)RestoreComplete(),n.msg&&n.msg!=""&&alert(n.msg);else if(n.complete==2){var t=confirm(n.msg);PageMethods.RestoreBackup(folderid,t,function(n){n=eval("("+n+")"),n.complete==1?RestoreComplete():InitRestore(),n.msg&&n.msg!=""&&alert(n.msg)})}else alert("操作失败："+n.msg),InitRestore()}function setSelected(){var n="";return $("#objsDiv .r:checkbox:checked").each(function(){n+=(n==""?"":",")+this.previousSibling.getAttribute("tid")}),n!=""?($("#selectedTids").val(n),!0):(alert("至少需要选择一项！"),!1)}function RestoreComplete(){__doPostBack("Updater",""),$("#uploadArea,#loading1").hide(),$("#msg").show(),$("#res_popup .btnArea").css("display",""),$("#res_btnCanel").val("确定");try{parent.leftFrame.reloadTabs("templets")}catch(n){}InitSortable()}function InitRestore(){$("#res_popup .btnArea,#uploadArea").css("display",""),$("#res_btnCanel").val("取消"),$("#loading1,#msg").hide()}function SelectedDir(n){var t=$("#attr_popup").length>0?"attr$aDefaultDir":"dm$removeTo";__doPostBack(t,n)}function xlsFileUpload(){var t=$("#xlsToUpload").val(),i=new RegExp("\\.(zip|xls|xml)$","i"),n;return i.test(t)?confirm("确定要导入该文件中的数据吗？")?(n=confirm("如果该Excel文件包含目前所存在的记录，是否更新它们？\n要更新，请点击确定；不更新，而是追加记录，请点击取消。"),$(document).ajaxStart(showLoading).ajaxComplete(hideLoading),$.ajaxFileUpload({url:"ajax.aspx?action=upload",secureuri:!1,fileElementId:"xlsToUpload",dataType:"json",success:function(t){if(typeof t.error!="undefined"&&t.error!="")alert(t.error);else{var i=t.files,r=null;typeof i!="undefined"&&i!=null&&i.length>0&&(r=i[0]),r==null?alert("文件上传失败！"):(PageMethods.ImportExcel(currentTid,r,n,Import_callback),processing=!0,showProgress(!0))}},error:function(n,t,i){hideLoading(),alert(i.name+":"+i.description)}}),!1):!1:(alert("无效的文件！"),!1)}function showProgress(n){(n||processing)&&(n?($("#MsgPop").hide(),doShowProgress(0,0,"未知"),setTimeout(function(){showProgress(!1)},1200)):$.getJSON("ajax.aspx",{action:"getProgress"},function(n){var i,t;switch(n.Status){case"Processing":i=n.Total==0?0:parseInt(n.Processed/n.Total*100),doShowProgress(i,n.Processed,n.Total),setTimeout(function(){showProgress(!1)},1200);break;case"Completed":t="",n.UpdatedCount>0&&(t+="成功更新"+n.UpdatedCount+"条记录，"),n.IgnoreCells>0&&(t+="忽略"+n.IgnoreCells+"个单元格，"),n.ImportCount>0&&(t+="成功导入"+n.ImportCount+"条记录，"),n.IgnoreCount>0&&(t+="忽略"+n.IgnoreCount+"行数据，"),t==""&&(t="已执行完毕，请检查执行结果。"),t=t.substr(0,t.length-1)+"。",n.ReportUrl!=null&&n.ReportUrl!=""&&(t+="<a href='"+n.ReportUrl+"' target='_blank'>详细报告<\/a>"),ShowMsgPop(t,-1),__doPostBack("Updater",""),processing=!1;break;case"Error":ShowMsgPop("操作失败："+n.Message,-1),processing=!1}}))}function doShowProgress(n,t,i){var r=n>0?n+"%":"0",u="<div style='width:96%;height:16px;border:1px #ccc solid;padding:1px;text-align:left;background:#fff'><div style='background:#00f;height:100%;overflow:hidden;width:"+r+"'><\/div><\/div><div class='center'>"+n+"% ("+t+"/"+i+")<\/div>";ShowMsgPop(u,0,"progress")}function Import_callback(n){hideLoading(),n!=null&&n!=""&&(processing=!1,ShowMsgPop(n,-1))}function ShowFilter(n){var t,i="advSearch.aspx?mode=temp&tid="+currentTid+"&timeStamp="+(new Date).getTime();return t=window.showModelessDialog?window.showModelessDialog(i,window,"dialogHeight:400px;dialogWidth:590px;center:yes;status:no;help:0;scroll:0"):window.open(i,"help","height=400,width=590,status=no,toolbar=no,menubar=no,location=no"),t==null?alert("条件设置窗口被拦截!\n请取消浏览器的弹出窗口屏蔽功能，或将本系统的网址加入浏览器的信任站点列表。"):$(n).prevAll(":checkbox:enabled").each(function(){$(this).data("oriChecked",this.checked).prop("checked",!0)}),!1}function CancelFilter(){$(".pop:visible a[onclick*='ShowFilter']").prevAll(":checkbox:enabled").each(function(){$(this).data("oriChecked")!=!0&&$(this).prop("checked",!1)})}function doConfirm(){return confirm("确定要更新"+($("#dm_cbFilter").is(":checked")?"符合当前条件的":"")+"所有记录的“"+$("#dm_ddlFieldsForUpdate option:selected").text()+"”吗？")}function SaveSC(){return checkCond()&&($f("savesc").className="visible"),!1}function CompletionShown(n){var t=$(n.get_completionList());t.show(),t.offset().top+t.height()-2>$("#ff_ulFilter li:last").offset().top?$("#ff_ulFilter li:last select").addClass("hidden"):$("#ff_ulFilter li:last select").removeClass("hidden"),$("#ff_ulFilter ul.completion").css("margin-left","0")}function CompletionHidden(){$("#ff_ulFilter li:last select").removeClass("hidden")}function addFolder(){var t=document.createElement("div"),r,i,n;return t.className="obj templetdir",r=document.createElement("div"),t.appendChild(r),i=document.createElement("span"),t.appendChild(i),n=document.createElement("input"),n.type="text",n.id="newName",n.value="新建文件夹",n.onfocus=function(){this.select()},n.onblur=doAddFolder,n.onkeydown=chkEnter,i.appendChild(n),$f("upDirs").appendChild(t),$f("newName").focus(),!1}function doAddFolder(){var n=getEventSrc(),t;if(!n)return!1;if(t=$.trim(n.value),t=="")return n.focus(),!1;n.disabled="disabled",PageMethods.AddFolder(t,folderid,add_callback)}function add_callback(n){var t=$f("newName"),i,u,r;n.substr(0,1)=="D"?(i=t.parentNode.previousSibling,i.onmouseover=mover,i.onmouseout=mout,i.onclick=doFolderDefault,i.oncontextmenu=showFolderMenu,u=document.createTextNode(t.value),t.parentNode.setAttribute("id",n),t.parentNode.replaceChild(u,t)):(r=t.parentNode.parentNode,r.parentNode.removeChild(r),alert(n))}function openFolder(){location=location.href.indexOf("DataAdmin")>-1?"templets.aspx?mode=DataAdmin&folder="+getFolderID():"templets.aspx?mode=TempletAdmin&folder="+getFolderID()}function doFolderDefault(){setSrcObj(getEventSrc()),openFolder()}function showFolderMenu(){return HasPanelShowing()||(srcObj=getEventSrc(),$("#curFolderId").val(getFolderID()),HideAllMenu(),ShowPop("folderMenu",!1)),CanelEvent()}function renameFolder(){var t=srcObj.nextSibling.firstChild,n=document.createElement("input");return n.type="text",n.id="newName",n.value=t.nodeValue,n.onfocus=function(){this.select()},n.onblur=doRenameFolder,n.onkeydown=chkEnter,oriNameNode=t.cloneNode(!0),t.parentNode.replaceChild(n,t),$f("newName").focus(),!1}function doRenameFolder(){var n=getEventSrc(),t;if(!n)return!1;if(n.value==oriNameNode.nodeValue)return n.parentNode.replaceChild(oriNameNode,n),!1;if(t=n.value.trim(),t=="")return n.focus(),!1;n.disabled="disabled",PageMethods.RenameFolder(getFolderID(),t,renameFolder_callback)}function renameFolder_callback(n){var t=$f("newName"),i;n==""?(i=document.createTextNode(t.value),t.parentNode.replaceChild(i,t)):(t.parentNode.replaceChild(oriNameNode,t),alert(n))}function setSource(){var n=getEventSrc(),i,t;if(n.id=="cutSelected"){if(t="",$("#objsDiv .r:checkbox:checked").each(function(){t+=(t==""?"":",")+this.previousSibling.getAttribute("tid")}),t=="")return alert("至少需要选择一项！"),!1;i=n.id+"|"+t}else i=n.id=="cutFolder"?n.id+"|"+getFolderID():n.id+"|"+currentTid;return $("#pasteSource").val(i),$.get("ajax.aspx",{SourceTemplet:i}),!1}function setReadCond(){var n=$("#power_ddlReadPower").val()=="-1";$("#power_cbReadCond,#rwPower a[onclick*='ShowFilter']").prop("disabled",n),n&&$("#power_cbReadCond").prop("checked",!1)}function InitSortable(){$("#upDirs,#objsDiv").sortable({items:"div.obj",handle:"div:first",helper:"clone",opacity:.7,ghosting:!1,scroll:!1,update:updateOrder}).find("div.obj").attr("title","点击打开，拖动调整位置")}function updateOrder(){var n="",t="",i;$("#upDirs div.obj").each(function(){i=$(this).find("span:last-child").attr("id").substr(1),n+=i+","}),$("#objsDiv div.obj").each(function(){i=$(this).find("span:first").attr("tid"),t+=i+","}),n.length>0&&(n=n.substr(0,n.length-1)),t.length>0&&(t=t.substr(0,t.length-1)),$.get("ajax.aspx",{action:"updateTempletOrder",folder:folderid,orders:n+"|"+t})}function toFind(){return __doPostBack("seek$btnOK",$("#tbFind").val()),HideDialog("seek_popup"),!1}function keyChanged(){var n=getEvent(),t=n.keyCode||n.which;return t==13?toFind():!0}function delRelation(n){if(confirm("确定删除与该模板的关联关系吗？"))__doPostBack("attr$btnDel",n);else return!1}function sync(n){var t=getEventSrc();if(confirm($(t).attr("title")+"是否确认该操作？"))__doPostBack("attr$btnSync",n);else return!1}function makeTabs(){$("#tabs").tabs().show()}var srcObj,currentTid,curParentMenu,oriNameNode,folderid=0,processing=!1;$(function(){document.oncontextmenu=showBodyMenu,document.onclick=HideAllMenu,document.ondblclick=function(){SelectAll("objsDiv")},document.onscroll=HideAllMenu,document.onselectstart=HideAllMenu,document.onmouseout=function(n){n=n||event;var t=n.clientX>=0&&n.clientX<document.documentElement.clientWidth&&n.clientY>=0&&n.clientY<document.documentElement.clientHeight;t||HideAllMenu()},InitSortable();var n=Sys.WebForms.PageRequestManager.getInstance();n.add_initializeRequest(showLoading),n.add_endRequest(hideLoading),$("#shortcut,#Open").mouseover(function(){curParentMenu=this.id})})