function setDdlLayouts(){$("#freeList").css("display",$("#tabs").tabs("option","active")==1?"":"none"),$("#saveLayout").css("display",$("#ddlLayouts").val()!=""?"":"none")}function toTableLayout(){alert("请拖动字段进行排版。"),HideDialog(),$("#tabs").tabs({active:0,activate:setDdlLayouts})}function setKeyWidth(){if($("#tabLayout").is(":visible")){var n=drag.width(),t=$("#zone0").width()*.8,i=n>t||n<minWidth;i&&(n=Math.min(Math.max(n,minWidth),t),$(".drag").width(n)),$("#zone2,#zone1,#zone0").find("td.key").width(n-6)}}function setZonePadBlock(){setKeyWidth(),$(".zone").each(function(){$("div.padBlock",this).remove(),$("table.item",this).length>0||$("<div class='padBlock'>请将字段拖入此处！<\/div>").appendTo(this)})}function InitDragWidth(){var n=$("td.key:first").outerWidth();$.browser.msie&&n++,$(".drag").width(n)}function InitEditor(){MakeEditor("textarea.ck","Advanced","280px",!1,!1)}function setLayout(){var t,n;if($tabs.tabs("option","active")>0)UpdateEditorElement(),__doPostBack("saveLayout","");else{for(t="",n=0;n<=2;n++)$("#zone"+n+" > table.item[fid]").each(function(i){t+=this.getAttribute("fid")+","+n+","+i+"|"});$("#recycle > table.item[fid]").each(function(n){t+=this.getAttribute("fid")+",255,"+n+"|"}),$.get("ajax.aspx",{action:"saveLayout",layoutType:3,layout:t},function(){var n=$(".key:first").width();$.browser.msie&&parseInt($.browser.version)<8&&n++,__doPostBack("btnSaveTable",n)})}return!1}function fmtsChanged(){switch($("#ddlFmts").val()){case"BarCode_1D":$(".forBarcode,#ddlSize").removeClass("hide");break;case"BarCode_2D":$(".forBarcode").addClass("hide"),$("#ddlSize").removeClass("hide");break;default:$(".forBarcode,#ddlSize").addClass("hide")}showTag()}function rangeChanged(n){$(n).val()=="Field"?($("#ddlVars").addClass("hide"),$("#ddlfs,#ddlFmts").removeClass("hide"),fmtsChanged()):($("#ddlVars").removeClass("hide"),$("#ddlfs,#ddlFmts").addClass("hide")),fsChanged()}function fsChanged(){$("#ddlFmts").val(""),fmtsChanged()}function showTag(){var t,i,n;if($("#range").val()=="Field"){i=$("#ddlfs").val();switch($("#ddlFmts").val()){case"":t="["+i+"]";break;case"BarCode_1D":n=$("#ddlSize").val(),n=n=="medium"?"":"|"+n,t="[_{"+$("#ddlBarCodes").val()+n+($("#cbLabel").is(":checked")?"|1":"")+"}"+i+"]";break;case"BarCode_2D":n=$("#ddlSize").val(),n=n=="medium"?"":"|"+n,t="[_{QrCode"+n+"}"+i+"]";break;default:t="[_"+i+"]"}}else t=$("#ddlVars").val();$("#fieldTag").val(t).fadeOut(100).fadeIn(300)}function addCond(){var n=getEventSrc(),t=$(n).closest("fieldset");return t.find("div.hide:first").removeClass("hide"),$(n).hide(),!1}function delQuery(n){if(confirm("删除查询定义后，编辑器中引用的这个查询将会失效。\n确定要删除这个查询定义吗？"))__doPostBack("btnDel",n);else return!1}function editQuery(n){__doPostBack("lbAddQuery",n)}function preAddLayout(){var n=!1,t;$("#ddlLayouts").val()!=""&&(t=CKEDITOR.instances.ckHtml,t.checkDirty()&&confirm("是否先保存当前正在编辑的版式？")&&(UpdateEditorElement(),n=!0)),$("#__EVENTARGUMENT").val(n)}function setDefault(){var n=getEventSrc(),t=$(n).closest("tr").attr("layoutid");__doPostBack("manage$btnManage","default_"+t)}function delLayout(){var i=getEventSrc(),n=$(i).closest("tr"),t;confirm("确定要删除版式“"+n.find("td:first").text()+"”吗？")&&(t=n.attr("layoutid"),__doPostBack("manage$btnManage","delete_"+t))}function rename(){var n=$(getEventSrc()),i=n.closest("tr"),t=i.find("td:first"),r;n.text()=="更名"?(r=t.text(),t.empty(),$("<input type='text' style='width:98%' value='"+r+"' title='回车提交' />").change(function(){var r=getEvent(),t,i;if(within(n,r))return!1;if(t=$.trim($(this).val()),i=$(this).closest("tr").attr("layoutid"),t==""||t==DeBase64(i))return alert("请输入新的版式名称！"),!1;__doPostBack("manage$btnManage",Base64(t)+"_"+i)}).keydown(function(){return getKeyCode()==13?($(this).change(),!1):!0}).appendTo(t),n.text("取消")):(n.text("更名"),t.text(DeBase64(i.attr("layoutid"))))}function edit(){var n=getEventSrc(),t=$(n).closest("tr"),i=t.find("td:first"),r=i.text();$("#tabs").tabs("option","active")==0&&$("#tabs").tabs({active:1,activate:setDdlLayouts}),$("#ddlLayouts").val(r),__doPostBack("ddlLayouts",""),HideDialog("manage_popup")}function toBack(){location.replace(location.href.replace(/detailLayout\.aspx/i,"detail.aspx"))}function confirmExit(){if((tableDirty||$("#ddlLayouts").val()!=""&&CKEDITOR.instances.ckHtml.checkDirty())&&!$(self.frameElement).is("iframe")){var n=document.activeElement;if(n&&$(n).is("[href^='javascript:']"))return!0;getEvent().returnValue=tableDirty?"表格版式尚未保存！":"当前的自由排版版式尚未保存！"}}var $tabs,drag,defTab=0,tableDirty=!1,minWidth=36;$(function(){$tabs=$("#tabs").tabs({active:defTab,activate:setDdlLayouts}).fadeIn(300),setDdlLayouts(),InitEditor(),$(".zone").sortable({connectWith:".zone",items:"table.item",handle:".key",helper:"clone",opacity:.7,ghosting:!1,scroll:!1,change:function(){tableDirty=!0},update:setZonePadBlock}),$("td.key").attr("title","拖动调整字段位置"),$(".drag").jqResize().attr("title","拖动调整字段名称列的宽度"),drag=$(".drag:first"),setZonePadBlock(),InitDragWidth(),$(document).mouseup(setKeyWidth);var n=Sys.WebForms.PageRequestManager.getInstance();n.add_initializeRequest(showLoading),n.add_endRequest(hideLoading),$(window).load(function(){hideLoading(),$("body").removeClass("waiting")})})